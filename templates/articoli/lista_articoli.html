{% extends 'homepage/index.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/folders_css/folders.css' %}"> 
    <link rel="stylesheet" href="{% static 'css/articoli_css/lista_articoli.css' %}">
{% endblock %}


{% block nav %}
<nav  class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a href="{% url 'folders:lista_cartelle' %}"class="btn btn-light me-3">
            <i class="bi bi-arrow-left"></i>
        </a>
        <i class="navbar-brand">Piattaforma Literature Review</i>
    </div>
</nav>  
{% endblock %}

{% block hero %}
    <div>
        <img src="{% static 'media/sfondo1.jpg' %}" alt="copertina" class="hero-image"></img>
    </div>
{% endblock %}

{% block container %}
<section class="hero2">
    <div class="container mt-5">
        <h2 class="text-center text-white fw-bold">üìö Articoli nella cartella: <span id="article-counter" class="text-info">{{ folder.num_ricerche }}</span></h2>
    </div>
</section>
{% endblock %}

{% block content  %}
<div class="container mt-5">

    <!-- Barra di ricerca e filtri -->
    <div class="row justify-content-center my-4">
        <div class="col-md-4">
            <!-- Campo input per la ricerca degli articoli -->
            <input type="text" id="search" class="form-control shadow" placeholder="üîç Cerca...">
        </div>
        <div class="col-md-2">
            <!-- Selezione dello stato degli articoli -->
            <select id="type" class="form-select shadow">
                <option value="">Stato: Tutti</option>
                <option value="Preso">Preso</option>
                <option value="Scartato">Scartato</option>
            </select>
        </div>
        <div class="col-md-2">
            <!-- Selezione della lingua degli articoli -->
            <select id="language" class="form-select shadow">
                <option value="">Lingua: Tutte</option>
                <option value="IT">Italiano</option>
                <option value="EN">Inglese</option>
                <option value="FR">Francese</option>
                <option value="ES">Spagnolo</option>
                <option value="DE">Tedesco</option>
                <option value="LT">Lituano</option>
                <option value="JP">Giapponese</option>
                <option value="CH">Cinese</option>
                <option value="RU">Russo</option>

            </select>
        </div>
    </div>

    <!-- Tabella degli articoli -->
    <div class="table-responsive">
        <table id="articoli-table" class="table table-hover table-bordered shadow bg-white">
            <thead class="table-dark text-center">
                <tr>
                    <th>Titolo</th>
                    <th>Autore</th>
                    <th>Anno</th>
                    <th>Citazioni</th>
                    <th>Fonti</th>
                    <th>Lingua</th>
                    <th>Tipo</th>
                    <th>Testo della Ricerca</th>
                    <th>Selezionato</th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for articolo in articoli %}
                <tr data-id="{{ articolo.id }}">
                    <td>‚Äã‚û§<a href="#" class="open-article-modal">{{ articolo.titolo }}</a></td>
                    <td>{{ articolo.autore|default_if_none:"" }}</td>
                    <td>{{ articolo.anno|default_if_none:"" }}</td>
                    <td>{{ articolo.citazioni|default_if_none:"0" }}</td>
                    <td>{{ articolo.fonte|default_if_none:"" }}</td>
                    <td>{{ articolo.get_lingua_display|default_if_none:"" }}</td>
                    <td>{{ articolo.tipo_documento|default_if_none:"" }}</td>
                    <td class="td-ellipsis">{{ articolo.text|default_if_none:"" }}</td>
                    <td>
                        {% if articolo.status == "Preso" %}
                            <!-- Checkbox disabilitato e selezionato se l‚Äôarticolo √® Preso -->
                            <input type="checkbox" class="form-check-input" checked disabled>
                            <span class="text-success fw-bold"> Preso </span>

                            <!-- Bottone per salvare il tag -->
                        {% else %}
                            <!-- Mostra una X se l‚Äôarticolo non √® Preso -->
                            <span class="text-danger fw-bold">‚ùåScartato</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td id="nessun-articolo-msg" colspan="7" class="text-center text-muted py-3">Nessun articolo presente in questa cartella.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <nav aria-label="Navigazione paginazione">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- I bottoni di paginazione verranno generati dinamicamente -->
        </ul>
    </nav>
    <!-- Bottoni di azione -->
    <div class="d-flex justify-content-center align-items-center gap-2 mt-4">
        <!-- Form per importare articoli -->
        <form id="importa-articoli-form" action="{% url 'articoli:importa_articoli' folder_id=folder.id %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}  <!-- oken CSRF per protezione delle richieste POST, √® nascosto ma viene usato nello script -->
            
            <span class="info-icon ms-2" data-bs-toggle="tooltip" data-bs-placement="top" 
                title="Title, Author, Year, Source title, Cited by, Document Type, Language, Testo della ricerca; ci vogliono i doppi apici all'inzio e alla fine di ogni elemento">
                
                <i class="bi bi-info-circle"></i>
            </span>
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="csv_file" name="csv_file" accept=".csv" required>
                <label class="custom-file-label" for="csv_file">Scegli file</label>
                
            <!-- Icona info con tooltip -->
            </div>
            <!-- Bottone per importare il file -->
            <div>
                <button id="import-button" type="button" class="btn-importa"> Importa</button>
            </div>
        </form>
        <!-- Bottone per aggiungere un nuovo articolo -->
        <a href="{% url 'articoli:aggiungi_articolo' folder.id %}" class="btn btn-aggiungi"> Aggiungi</a>
        <!-- Bottone per salvare le ricerche -->
        <button id="save-searches" data-cartella-id="{{ folder.id }}" class="btn btn-salva shadow" >üíæ Salva</button>
    </div>
    <h2 class="text-center text-white fw-bold">Esempio di file</h2>
    <div class="table-responsive">
        <table id="articoli-table" class="table table-hover table-bordered shadow bg-white">
            <thead class="table-dark text-center">
                <tr>
                    <th>Titolo</th>
                    <th>Autore</th>
                    <th>Anno</th>
                    <th>Citazioni</th>
                    <th>Fonti</th>
                    <th>Lingua</th>
                    <th>Tipo</th>
                    <th>Testo della Ricerca</th>
                    <th>Selezionato</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr data-id="{{ articolo.id }}">
                    <td>‚Äã‚û§"Advancements in Quantum Computing"</a></td>
                    <td>"J. Doe"</td>
                    <td>2023</td>
                    <td>15</td>
                    <td>"Journal of Quantum Science"</td>
                    <td>"EN"</td>
                    <td>"Article"</td>
                    <td> "Questo studio esplora gli..."</td>
                    <td>‚ùå Scartato</td>
        </table>
    </div>
</div>
<!-- Modal per visualizzare i dettagli dell'articolo -->
<div class="modal fade" id="articleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <input type="hidden" id="articleId">
                <h5 class="modal-title" id="articleTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Autore:</strong> <span id="articleAuthor"></span></p>
                <p><strong>Anno:</strong> <span id="articleYear"></span></p>
                <p><strong>Fonte:</strong> <span id="articleSource"></span></p>
                <p><strong>Citazioni:</strong> <span id="articleCitations"></span></p>
                <p><strong>Lingua:</strong> <span id="articleLanguage"></span></p>
                <p><strong>Tipo Documento:</strong> <span id="articleType"></span></p>
                <p><strong>Testo della Ricerca:</strong></p>
                <textarea id="articleText" class="form-control" rows="5" readonly></textarea>

                <!-- Modifica lo stato (Preso/Scartato) -->
                <div class="mt-3">
                    <label class="form-label"><strong>Stato:</strong></label>
                    <select id="articleStatus" class="form-select">
                        <option value="Preso">‚úÖ Preso</option>
                        <option value="Scartato">‚ùå Scartato</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="prevArticle" class="btn btn-secondary">¬´ Precedente</button>
                <button id="saveStatus" class="btn btn-primary">Salva Stato</button>
                <button id="nextArticle" class="btn btn-secondary">Successivo ¬ª</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block contact %}

{% endblock %}

{% block footer %}

{% endblock %}

{% block script %}
<!--Script per importare articoli -->
<script>
let articles = [];  // Variabile globale 
let currentIndex = 0;  // Variabile per tenere traccia dell'articolo attuale 

document.addEventListener("DOMContentLoaded", function () {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    assegnaEventiModaleArticoli();
    
    gestioneSalvataggio(); // Gestione del salvataggio 

    let submitButton = document.getElementById("import-button");
    let searchInput = document.getElementById("search");
    let statusFilter = document.getElementById("type");
    let languageFilter = document.getElementById("language");
    let pagination = document.getElementById("pagination");
    let itemsPerPage = 5; // Numero massimo di articoli per pagina

    // Importazione articoli con aggiornamento dinamico
    submitButton.addEventListener("click", function (event) {
        event.preventDefault(); // Evita il refresh della pagina

        let form = document.getElementById("importa-articoli-form");
        let csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        let formData = new FormData(form);
        formData.append("csrfmiddlewaretoken", csrfToken);

        function aggiornaContatoreArticoli(total) {
            let counterElement = document.getElementById("article-counter");

            if (!counterElement) {
                console.warn("‚ö†Ô∏è Elemento 'article-counter' non trovato nel DOM.");
                return;
            }

            counterElement.textContent = total; // Aggiorna il contatore degli articoli
        }

        fetch(form.action, {
            method: "POST",
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                console.log("üîÑ Nuovo numero di articoli:", data.total_articoli);

                aggiornaContatoreArticoli(data.total_articoli);

                let nessunArticoloMsg = document.getElementById("nessun-articolo-msg");
                if (nessunArticoloMsg) {
                    nessunArticoloMsg.style.display = "none";
                }

                aggiornaTabella(data.articoli); // Aggiorna la tabella con i nuovi articoli
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            } else {
                alert(data.error);
            }
        })
        .catch(error => console.error("Errore:", error));
    });

    // Funzione per aggiornare la tabella con i nuovi articoli importati
    function aggiornaTabella(articoli) {
        let tbody = document.getElementById("table-body");
        tbody.innerHTML = ""; // Svuota la tabella prima di aggiornare

        articoli.forEach(articolo => {
            let row = document.createElement("tr");
            row.setAttribute("data-id", articolo.id); // Assicura che l'ID sia presente e memorizza l'ID nel dataset della riga

            row.innerHTML = `
                <td>‚û§<a href="#" class="open-article-modal">${articolo.titolo}</a></td>
                <td>${articolo.autore}</td>
                <td>${articolo.anno}</td>
                <td>${articolo.citazioni}</td>
                <td>${articolo.fonte}</td>
                <td>${articolo.lingua}</td>
                <td>${articolo.tipo_documento}</td>
                <td class="td-ellipsis">${articolo.text ? articolo.text : "Nessun testo disponibile"}</td>
                <td>${articolo.status === "Preso" ? "‚úÖ Preso" : "‚ùå Scartato"}</td>
            `;

            tbody.appendChild(row);
        });

        assegnaEventiModaleArticoli(); // Riassegna gli eventi ai nuovi articoli
        gestisciPaginazione();
    }

    // Funzione per assegnare gli eventi di apertura modale agli articoli
    function assegnaEventiModaleArticoli() {
        articles = Array.from(document.querySelectorAll("#articoli-table tbody tr"));

        document.querySelectorAll(".open-article-modal").forEach((link, index) => {
            link.addEventListener("click", function (event) {
                event.preventDefault();
                currentIndex = index; // Memorizza l'indice corrente
                openArticleModal(articles[currentIndex]); // Apre il modale con l'articolo selezionato
            });
        });
    }

    // Funzione per aprire il modale con i dettagli dell'articolo
    function openArticleModal(row) {
        if (!row) {
            console.error("‚ùå Errore: Nessuna riga selezionata!");
            return;
        }
    
        let articleId = row.dataset.id; // Ottiene l'ID dal dataset della riga
    
        if (!articleId || articleId === "undefined" || articleId === "") {
            console.error("‚ùå Errore: ID articolo non valido! Riga:", row);
            alert("‚ö†Ô∏è Errore: L'ID dell'articolo non √® valido!");
            return;
        }
    
        console.log("üîç ID articolo selezionato:", articleId); // Debug
    
        let articleIdInput = document.getElementById("articleId");
        if (articleIdInput) {
            articleIdInput.value = articleId;
        } else {
            console.warn("‚ö†Ô∏è Elemento nascosto per ID non trovato!");
        }
        
        document.getElementById("articleTitle").textContent = row.cells[0].textContent.trim();
        document.getElementById("articleAuthor").textContent = row.cells[1].textContent.trim();
        document.getElementById("articleYear").textContent = row.cells[2].textContent.trim();
        document.getElementById("articleCitations").textContent = row.cells[3].textContent.trim();
        document.getElementById("articleSource").textContent = row.cells[4].textContent.trim();
        document.getElementById("articleLanguage").textContent = row.cells[5].textContent.trim();
        document.getElementById("articleType").textContent = row.cells[6].textContent.trim();
        document.getElementById("articleText").value = row.cells[7].textContent.trim();
        document.getElementById("articleStatus").value = row.cells[8].textContent.includes("Preso") ? "Preso" : "Scartato";

        let modal = new bootstrap.Modal(document.getElementById("articleModal"));
        modal.show();
    }

    // Gestione pulsanti "Precedente" e "Successivo"
    document.getElementById("prevArticle").addEventListener("click", function () {
        if (currentIndex > 0) {
            currentIndex--;
            openArticleModal(articles[currentIndex]);
        }
    });

    document.getElementById("nextArticle").addEventListener("click", function () {
        if (currentIndex < articles.length - 1) {
            currentIndex++;
            openArticleModal(articles[currentIndex]);
        }
    });

    // Funzione per il pulsante "Salva Stato"
    document.getElementById("saveStatus").addEventListener("click", function () {
        let articleId = document.getElementById("articleId").value;
        let newStatus = document.getElementById("articleStatus").value;

        if (!articleId || articleId === "undefined") {
            console.error("‚ùå Errore: ID articolo non valido!");
            alert("‚ö†Ô∏è Errore: Impossibile salvare lo stato perch√© l'ID √® mancante.");
            return;
        }

        fetch("/articoli/modifica-stato/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify({
                id: articleId,
                nuovo_stato: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("‚úÖ Stato aggiornato con successo!");
                let row = document.querySelector(`#table-body tr[data-id="${articleId}"]`);
                row.cells[8].innerHTML = newStatus === "Preso" ? "‚úÖ Preso" : "‚ùå Scartato";
            } else {
                alert("‚ùå Errore: " + data.error);
            }
        })
        .catch(error => console.error("Errore:", error));
    });

    // Risolve il problema dello sfondo nero
    document.getElementById("articleModal").addEventListener("hidden.bs.modal", function () {
    document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
    document.body.classList.remove("modal-open");
    });    

    function gestisciPaginazione() {
        let table = document.getElementById("table-body");
        let rows = Array.from(table.getElementsByTagName("tr"));
        let totalItems = rows.length;
        let totalPages = Math.ceil(totalItems / itemsPerPage);
        let pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
    
        const maxVisiblePages = 5; // Numero massimo di numeri di pagina visibili
        let currentPage = 1; // La pagina attuale
    
        function showPage(page) {
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
    
            let start = (page - 1) * itemsPerPage;
            let end = start + itemsPerPage;
    
            rows.forEach((row, index) => {
                row.style.display = (index >= start && index < end) ? "" : "none";
            });
    
            currentPage = page;
            renderPagination();
        }
    
        function renderPagination() {
            pagination.innerHTML = "";
    
            // Bottone "Precedente"
            let prevLi = document.createElement("li");
            prevLi.classList.add("page-item");
            if (currentPage === 1) prevLi.classList.add("disabled");
            prevLi.innerHTML = `<button class="page-link">‚ùÆ Precedente</button>`;
            prevLi.addEventListener("click", function () {
                if (currentPage > 1) {
                    showPage(currentPage - 1);
                }
            });
            pagination.appendChild(prevLi);
    
            // Generazione delle pagine con ellissi
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
    
            if (startPage > 1) {
                let firstPage = document.createElement("li");
                firstPage.classList.add("page-item");
                firstPage.innerHTML = `<button class="page-link">1</button>`;
                firstPage.addEventListener("click", function () {
                    showPage(1);
                });
                pagination.appendChild(firstPage);
    
                if (startPage > 2) {
                    let dots = document.createElement("li");
                    dots.classList.add("page-item", "disabled");
                    dots.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(dots);
                }
            }
    
            for (let i = startPage; i <= endPage; i++) {
                let li = document.createElement("li");
                li.classList.add("page-item");
                if (i === currentPage) li.classList.add("active");
    
                let button = document.createElement("button");
                button.classList.add("page-link");
                button.innerText = i;
                button.addEventListener("click", function () {
                    showPage(i);
                });
    
                li.appendChild(button);
                pagination.appendChild(li);
            }
    
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    let dots = document.createElement("li");
                    dots.classList.add("page-item", "disabled");
                    dots.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(dots);
                }
    
                let lastPage = document.createElement("li");
                lastPage.classList.add("page-item");
                lastPage.innerHTML = `<button class="page-link">${totalPages}</button>`;
                lastPage.addEventListener("click", function () {
                    showPage(totalPages);
                });
                pagination.appendChild(lastPage);
            }
    
            // Bottone "Avanti"
            let nextLi = document.createElement("li");
            nextLi.classList.add("page-item");
            if (currentPage === totalPages) nextLi.classList.add("disabled");
            nextLi.innerHTML = `<button class="page-link">Avanti ‚ùØ</button>`;
            nextLi.addEventListener("click", function () {
                if (currentPage < totalPages) {
                    showPage(currentPage + 1);
                }
            });
            pagination.appendChild(nextLi);
        }
    
        if (totalPages > 1) {
            renderPagination();
        }
    
        showPage(1);
    }
    
    
        // Ricerca e filtri
        function ricercaArticoli() {
            let query = searchInput.value.trim();
            let stato = statusFilter.value;
            let lingua = languageFilter.value;
            let folderId = "{{ folder.id }}";
    
            fetch(`/articoli/ricerca/${folderId}/?q=${query}&stato=${stato}&lingua=${lingua}`)
                .then(response => response.json())
                .then(data => {
                    aggiornaTabella(data.articoli);
                    gestisciPaginazione();
                })
                .catch(error => console.error("Errore nella ricerca:", error));
        }
    
        searchInput.addEventListener("input", ricercaArticoli);
        statusFilter.addEventListener("change", ricercaArticoli);
        languageFilter.addEventListener("change", ricercaArticoli);
    
        // Esegue la paginazione al caricamento
        gestisciPaginazione();
    });
    function gestioneSalvataggio() {
        let saveButton = document.getElementById("save-searches");
    
        if (saveButton) {
            saveButton.addEventListener("click", function() {
                let folderId = this.getAttribute("data-cartella-id") || "";
                if (!folderId.trim()) {
                    console.error("‚ùå Errore: ID cartella non valido!");
                    alert("‚ö†Ô∏è Errore: ID cartella non trovato!");
                    return;
                }
    
                console.log("Cartella ID:", folderId);  // Debugging
    
                fetch(`/cartella/${folderId}/salva-ricerche/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Errore HTTP! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }
                })
                .catch(error => console.error("Errore nel salvataggio:", error));
            });
        } else {
            console.warn("‚ö†Ô∏è Il pulsante 'save-searches' non √® stato trovato nel DOM.");
        }
    };    
</script>

{% endblock %}